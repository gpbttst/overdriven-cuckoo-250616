<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="pragma" content="no-cache"/>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name ="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <meta charset="utf-8"/>
  <script src="https://survey.kykyshka.ru/surveyApi.js"></script>
  <style>
  body {
	background: #8684cc;
	display: flex;
	justify-content: center;
	align-items: center;
	font-family: sans-serif;
	color: white;
	height: 100%;
	overflow: hidden;
  }
  #text {
	font-size: 3vmax;
  }
  .idle {
    opacity: 1;
    animation: fade 1s linear infinite;
  }


  @keyframes fade {
    0%,100% { opacity: 1 }
    50% { opacity: 0.5 }
  }
  </style>
<title>Опрос</title>
</head>
<body>
	<p id="text" class="idle">Подождите...</p>
<script type="text/javascript">
//{   "surveyKey": "c52b8eb9-00e0-442b-b754-d180e5bbdf87",   "block": {     "id": "c52b8eb9-00e0-442b-b754-d180e5bbdf87",     "questions": [       {         "id": "2bf5d313-436c-49b1-b4ff-d5021777f944",         "category": 1,         "text": "Привет! Теперь ты будешь получать награды в игре за ответы на вопросы!",         "answers": [           {             "text": "Продолжить",             "screening": false,             "redirect": null,             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           }         ],         "shuffle": 0,         "customParams": "{\"oldSingleSelect\":true,\"privacy\":{\"text\":\"Нажимая \\\"Продолжить\\\", я соглашаюсь с:\",\"checks\":[{\"text\":\"доступом сервиса к моим данным: пол, возраст, образование, регион\",\"link\":\"terms/dataaccess.html\",\"checked\":true,\"required\":true},{\"text\":\"Пользовательским соглашением\",\"link\":\"terms/useragreement.html\",\"checked\":true,\"required\":true},{\"text\":\"Политикой конфиденциальности\",\"link\":\"terms/privacypolicy.html\",\"checked\":true,\"required\":true}]}}",         "targetId": 0,         "picture": "",         "minAnswersNumber": 0,         "maxAnswersNumber": 0,         "minIntValue": 0,         "maxIntValue": 0       },       {         "id": "9f693972-c812-4a65-a407-8ff0ef96f185",         "category": 4,         "text": "Тебе есть 16 лет?",         "answers": [           {             "text": "Да",             "screening": false,             "redirect": {               "toType": 7,               "itemId": ""             },             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           },           {             "text": "Нет",             "screening": false,             "redirect": null,             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           }         ],         "shuffle": 0,         "customParams": "{\"oldSingleSelect\":true}",         "targetId": 0,         "picture": "",         "minAnswersNumber": 0,         "maxAnswersNumber": 0,         "minIntValue": 0,         "maxIntValue": 0       },       {         "id": "a73fcc50-2119-4e08-8499-7469f99f2f2b",         "category": 1,         "text": "А сколько тебе лет?",         "answers": [           {             "text": "15",             "screening": false,             "redirect": null,             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           },           {             "text": "14",             "screening": false,             "redirect": null,             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           }         ],         "shuffle": 0,         "customParams": "{\"oldSingleSelect\":true}",         "targetId": 0,         "picture": "",         "minAnswersNumber": 0,         "maxAnswersNumber": 0,         "minIntValue": 0,         "maxIntValue": 0       },       {         "id": "cea7013b-8ade-4426-b77a-116248e944a0",         "category": 1,         "text": "Попроси родителя или опекуна подтвердить согласие на твоё участие в опросах",         "answers": [           {             "text": "Подтверждаю",             "screening": false,             "redirect": null,             "picture": "",             "customAnswer": false,             "customParams": "",             "answerGroup": 0           }         ],         "shuffle": 0,         "customParams": "{\"parentTextField\":true}",         "targetId": 0,         "picture": "",         "minAnswersNumber": 0,         "maxAnswersNumber": 0,         "minIntValue": 0,         "maxIntValue": 0       }     ],     "customParams": "{\"isPrivacy\":true}",     "type": "UNSPECIFIED"   } }
//{"surveyKey":"1e5d5373-3dd6-4936-8813-5594e64baa94","block":{"id":"1e5d5373-3dd6-4936-8813-5594e64baa94","questions":[{"id":"3991685f-9403-431a-ba64-172d5878857f","category":3,"text":"Скрининговый","answers":[{"text":"Отсеять","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"Не отсеять","screening":true,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"Отсеять","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0}],"shuffle":0,"customParams":"","targetId":0,"picture":"","minAnswersNumber":0,"maxAnswersNumber":0,"minIntValue":0,"maxIntValue":0},{"id":"f52afd9b-43f7-4a0b-9e60-3bd091502b0a","category":2,"text":"Выбери 1-2 вариантов ответа","answers":[{"text":"1","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"2","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"3","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"4","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0}],"shuffle":0,"customParams":"","targetId":0,"picture":"","minAnswersNumber":1,"maxAnswersNumber":2,"minIntValue":0,"maxIntValue":0},{"id":"7ec1d486-9c43-4f6d-8127-2118c7c4a939","category":5,"text":"Введи свой ответ","answers":[],"shuffle":0,"customParams":"","targetId":0,"picture":"","minAnswersNumber":0,"maxAnswersNumber":0,"minIntValue":0,"maxIntValue":0},{"id":"da7749cd-e0c9-4898-9922-c865b328a91c","category":6,"text":"А тут введи число от 0 до 500","answers":[{"text":"0","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0},{"text":"500","screening":false,"redirect":null,"picture":"","customAnswer":false,"customParams":"","answerGroup":0}],"shuffle":0,"customParams":"","targetId":0,"picture":"","minAnswersNumber":0,"maxAnswersNumber":0,"minIntValue":0,"maxIntValue":0},{"id":"1c3d3aa2-fcb1-4710-b3ad-62d79b09cbdc","category":1,"text":"Картинки","answers":[{"text":"Другое. Укажите свой вариант","screening":false,"redirect":null,"picture":"","customAnswer":true,"customParams":"","answerGroup":0},{"text":" ","screening":false,"redirect":null,"picture":"https://account.kykyshka.ru/api/v1/service/picture?pic=GfQV4WxD67v1Fes7WFNdbfgnKkTsPgBq.png","customAnswer":false,"customParams":"","answerGroup":0},{"text":" ","screening":false,"redirect":null,"picture":"https://account.kykyshka.ru/api/v1/service/picture?pic=EiJumqago79unSRKSfUaeAoxAyEuVchl.png","customAnswer":false,"customParams":"","answerGroup":0}],"shuffle":0,"customParams":"","targetId":0,"picture":"https://account.kykyshka.ru/api/v1/service/picture?pic=hdqgMZjURR3hdakDSXY9VecFYFAfRjUj.png","minAnswersNumber":0,"maxAnswersNumber":0,"minIntValue":0,"maxIntValue":0}],"customParams":"","type":"UNSPECIFIED"}}
	window.onload=function(){
		var _uid="internal_"+surveyMaster.crypt.MD5(Date.now().toString())
		var _gid="RoITaurNEnWpG68yOi7eAPaJXRx4fjvZSN9f84gaX3mUQE5jHlC74rBco04MPVz3";
		try {
			var _p=localStorage.getItem("kykyUserId");
			if (_p===null)
				localStorage.setItem("kykyUserId",_uid);
			else
				_uid=_p;
		}catch(e){}
		var urlParams=new URLSearchParams(window.location.search);
		if (typeof urlParams.get("uid")=="string")
			_uid="internal_"+utoa(urlParams.get("uid"));
		var projectData={};
		function handler() {
			getBlock(projectData.id,this.dataset.block);
		}
		surveyMaster.setUserId(_uid);
		surveyMaster.init(_gid);
		//surveyMaster.surveyURL="index.html";
		surveyMaster.surveyUrlParams.hideCross="1";
		if (typeof urlParams.get("d")=="string")
		{
			console.log(_uid);
			getBlock(urlParams.get("d"),_uid);	
		}
		
		surveyMaster.addCallback("onSuccess",function(unqualified) {
			document.getElementById("text").classList.remove("idle");
			document.getElementById("text").innerHTML="Спасибо!<br>Можете закрыть это окно";
		});
		surveyMaster.addCallback("onSurveyUnavailable",function() {
		document.getElementById("text").classList.remove("idle");
			document.getElementById("text").innerHTML="Опрос не найден";
		});
		surveyMaster.addCallback("onLoadFail",function() {
			document.getElementById("text").classList.remove("idle");
			document.getElementById("text").innerHTML="Ошибка загрузки";
		});
		surveyMaster.addCallback("onSurveyStart",function() {
			document.getElementById("text").classList.remove("idle");
		});
	};
	window.addEventListener("message",(event) => {
		try {
			if (typeof event.data==="string")
			{
				if (event.data.includes("kykyshkaDebug"))
				{
					var _data=JSON.parse(event.data);
					if (_data.hasOwnProperty("kykyshkaDebug"))
					{
						if (_data.kykyshkaDebug.hasOwnProperty("action"))
						{
							switch (_data.kykyshkaDebug.action)
							{
								case "grabBlock":
									/*document.querySelector("iframe").contentWindow.postMessage({kykyshkaDebug:JSON.parse(document.getElementById("jsonInput").value)},"*");
									showSurvey();*/
								break;
								default:
								break;
							}
						}
					}
				}
			}
		}
		catch(e) {console.log(e);
			return;
		}
	}, false);
	function utoa(data) {
		return btoa(unescape(encodeURIComponent(data)));
	}
	function getBlock(pid,uid) {
		var _pId=pid;
		var _uId=uid;
		var _req=new XMLHttpRequest();
		_req.open("POST","https://api.kykyshka.ru/v1/service/survey/assign",true);
		_req.setRequestHeader("Content-type","application/json; charset=UTF-8");
		_req.send(JSON.stringify({project_id:_pId,user_id:_uId}));
		_req.onload=function() {
			if (_req.response)
			{
				try {
					var _rr=JSON.parse(_req.response);
					var _txtEl=document.getElementById("text");
					switch(_rr.message)
					{
						case "first block finished": 
							_txtEl.innerHTML="Вы уже прошли этот опрос :)"
						break;
						default: break;
					}
				}catch(e){}
			}
			if (_req.status==200)
				surveyMaster.showSurvey();
		}
	}
function declOfNum(number, titles)
{
    cases = [2, 0, 1, 1, 1, 2];
    return titles[ (number%100>4 && number%100<20)? 2 : cases[(number%10<5)?number%10:5] ];
}
</script>
</body>
</html>
